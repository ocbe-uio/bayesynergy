<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="bayesynergy">
<title>Advanced topics • bayesynergy</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced topics">
<meta property="og:description" content="bayesynergy">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">bayesynergy</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.5.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/bayesynergy.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Model.html">Mathematical model</a>
    <a class="dropdown-item" href="../articles/Example_single.html">Example: Single experiment</a>
    <a class="dropdown-item" href="../articles/Example_screen.html">Example: Multiple experiments</a>
    <a class="dropdown-item" href="../articles/Advanced_topics.html">Advanced topics</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Advanced topics</h1>
            
      
      
      <div class="d-none name"><code>Advanced_topics.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="diagnosing-errors-and-warnings">Diagnosing errors and warnings<a class="anchor" aria-label="anchor" href="#diagnosing-errors-and-warnings"></a>
</h2>
<p>Sometimes, the <code>bayesynergy</code> function may return with a
warning. Ideally, we don’t want any warnings at all, and they should be
examined closely, as posterior samples could be unreliable. Usually, the
warning will tell the user how to fix the problem at hand, e.g. by
running the chains for longer (set <code>iter</code> higher), or setting
<code>adapt_delta</code> higher. See [<a href="https://mc-stan.org/misc/warnings.html" class="external-link uri">https://mc-stan.org/misc/warnings.html</a>] for some general
tips.</p>
<div class="section level3">
<h3 id="divergent-transitions">Divergent Transitions<a class="anchor" aria-label="anchor" href="#divergent-transitions"></a>
</h3>
<p>Most commonly, the sampler might complain about divergent
transitions. The warning will typically look like this:</p>
<pre><code><span><span class="co">## Warning: There were 2316 divergent transitions after warmup. See</span></span>
<span><span class="co">## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">## to find out why this is a problem and how to eliminate them.</span></span></code></pre>
<p>This is indicative of a posterior geometry that is tricky to explore.
In the case where there is only a few divergent transitions, the usual
trick is to set <code>adapt_delta</code> to a higher value, i.e. larger
than 0.9 which is the default. This can be done through the
<code>control</code> option in the <code>bayesynergy</code> call:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/BayeSyneRgy.html">bayesynergy</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>However, the case above, where there are 2316 divergent transitions,
is indicative of a misspecified model. In my experience, this can happen
for a few reasons.</p>
<ul>
<li>Estimating ‘flat’ monotherapies
<ul>
<li>i.e. when the parameter <span class="math inline">\(l\)</span> is
close to one. This can have the effect of making the other monotherapy
parameters unidentifiable.</li>
<li>this can usually be alleviated by setting
<code>lower_asymptotes = FALSE</code> in the call. Unless one is
specifically interested in these parameters, there are no reason to
estimate them – the model fit will typically still be good without
them.</li>
</ul>
</li>
<li>Estimating <span class="math inline">\(l\)</span> in the
heteroscedastic model
<ul>
<li>the model can struggle in this setting, particularly if there are
none or few replicates.</li>
<li>choose a homoscedastic model instead.</li>
</ul>
</li>
<li>‘Wrong’ <span class="math inline">\(\lambda\)</span> value
<ul>
<li>sometimes setting <span class="math inline">\(\lambda\)</span> much
lower than the initial setting can help with a better fit. This is
particularly true if viability scores close to zero (or negative) are
truncated or set to exactly zero.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="robustness-against-outliers">Robustness against outliers<a class="anchor" aria-label="anchor" href="#robustness-against-outliers"></a>
</h2>
<p>We provide a version of the model that is more robust against
inevitable outliers in dose=response data. This is done by swapping out
two components of the model formulation, the likelihood and the prior
for kernel hyperparameters.</p>
<p>For the likelihood, we utilise the log-Pareto-tailed Normal (LPTN)
distribution with mean <span class="math inline">\(\mu\)</span> and
standard deviation <span class="math inline">\(\sigma\)</span>, as
described in <span class="citation">Gagnon, Desgagné, and Bédard
(2020)</span> which takes the form <span class="math display">\[
f(x)=
\begin{cases}
\frac{1}{\sigma}\phi\left(\frac{x-\mu}{\sigma}\right) &amp; \text{if }
\vert\frac{x-\mu}{\sigma}\vert \leq \tau \\
\frac{1}{\sigma}\phi(\tau)\frac{\tau}{\vert\frac{x-\mu}{\sigma}\vert}\left(\frac{\log
(\tau)}{\log(\vert\frac{x-\mu}{\sigma}\vert)}\right)^{\lambda+1} &amp;
\text{if } \vert\frac{x-\mu}{\sigma}\vert &gt; \tau
\end{cases}
\]</span> where <span class="math inline">\(\phi\)</span> denotes the
standard normal pdf. The parameters <span class="math inline">\((\tau,\lambda)\)</span> are controlled by the
user-specified hyperparameter <span class="math inline">\(\rho \in
(2\Phi(1)-1,1)\)</span> as <span class="math display">\[
\tau=\Phi^{-1}((1+\rho)/2),  \ \ \ \
\lambda=2(1-\rho)^{-1}\phi(\tau)\tau\log(\tau)
\]</span></p>
<p>The robust likelihood can be utilized by setting
<code>robust = T</code> when calling the<code>bayesynergy</code>
function. The user-specified parameter <span class="math inline">\(\rho\)</span> can be set by the <code>rho</code>
argument, by default set to <span class="math inline">\(0.9\)</span>.</p>
<p>For the kernel, we recommend utilising the Matérn kernel with a
Penalized Complexity (PC) prior on the kernel hyperparameters. The PC
prior for the Matern covariance was described in <span class="citation">Fuglstad et al. (2018)</span>, and strongly encourages
small deviations from the null model, i.e. high probability of an
interaction term being zero. The PC prior for the kernel hyperparameters
<span class="math inline">\((\sigma_f^2,\ell)\)</span> (in the
2-dimensional case) takes the form <span class="math display">\[
\pi(\sigma_f^2,\ell)=\tilde{\lambda}_1\tilde{\lambda}_2\ell^{-2}\sigma_f^{-1}\exp\left(-\tilde{\lambda}_1\ell^{-1}-\tilde{\lambda}_2\sigma_f\right),
\]</span> where <span class="math inline">\((\tilde{\lambda}_1,\tilde{\lambda}_2)\)</span> are
set to reflect prior beliefs <span class="math inline">\(P(\ell &lt;
\ell_0)=\alpha_1\)</span> and <span class="math inline">\(P(\sigma_f^2
&gt; \sigma^2_{f0})=\alpha_2\)</span> by <span class="math display">\[
\tilde{\lambda}_1=-\log(-\alpha_1)\ell \ \ \ \
\tilde{\lambda}_2=-\frac{\log(\alpha_2)}{\sigma_{f0}^2},
\]</span> where <span class="math inline">\((\ell_0,\alpha_1,\sigma_{f0}^2,\alpha_2)\)</span>
are hyperparameters that are set by the user. The PC prior can be
enabled by setting <code>pcprior = T</code> when calling the
<code>bayesynergy</code> function, and hyperparameters specified by the
argument <code>pcprior_hypers</code>. By default, we recommend <span class="math inline">\((\ell_0,\alpha_1,\sigma_{f0}^2,\alpha_2)=(1,0.1,1,0.2)\)</span>.</p>
</div>
<div class="section level2">
<h2 id="including-controls">Including controls<a class="anchor" aria-label="anchor" href="#including-controls"></a>
</h2>
<p>The positive and negative controls essentially control the
signal-to-noise ratio in cell viability assays. If the user has access
to these, they can be included in the model to help calibrate the
posterior distribution – particularly in the case with zero
replicates.</p>
<p>Let <span class="math inline">\(\xi^-_k\)</span> and <span class="math inline">\(\xi^+_l\)</span> denote the negative and positive
controls for <span class="math inline">\(k=1,\ldots,n_-\)</span> and
<span class="math inline">\(l=1,\ldots,n_+\)</span>. These measurements
are raw readings from the plate and are used to calculate cell
viability. For an additional well, treated with drug concentration <span class="math inline">\(\mathbf{x}_i\)</span>, we denote the raw output by
<span class="math inline">\(\xi_i\)</span>, and calculate cell viability
for this well by the formula: <span class="math display">\[
y_i = \frac{\xi_i-\tilde{\xi^+}}{\tilde{\xi^-}-\tilde{\xi^+}},
\]</span> where <span class="math inline">\(\tilde{\xi^-}\)</span> and
<span class="math inline">\(\tilde{\xi^+}\)</span> denotes some measure
of centrality of the positive and negative controls, typically the mean
or median.</p>
<p>The controls can themselves be passed through this function and
converted to % viability. From the variances of these normalized
controls, <span class="math inline">\(\lambda\)</span> can be set as
indicated above. And the negative controls can be added directly into
the algorithm. Negative controls represents unhindered cell growth, and
can be thought of as samples from the dose-response function <span class="math inline">\(f(\mathbf{x})\)</span> at concentration <span class="math inline">\(\mathbf{x}=(0,0)\)</span>. These can then be added
directly to the <span class="math inline">\(\texttt{bayesynergy}\)</span> function in the same
way as regular observations.</p>
</div>
<div class="section level2">
<h2 id="synergy-classification">Synergy classification<a class="anchor" aria-label="anchor" href="#synergy-classification"></a>
</h2>
<p>Frequently, it is of interest to classify an experiment as
<em>synergistic</em> or <em>antagonistic</em>. Usually, this has been
done by thresholding the synergy measure at a certain level, declaring
e.g. everything above 10 as synergistic, everything below -10
antagonistic, and anything in between as additive (no interaction). The
problem with this is that it completely ignores the underlying
measurement error, and as a consequence the thresholding procedure can
lead to misclassification. Large synergistic effects might be classified
as synergistic, but in reality the effect cannot be discerned from the
background noise. In the same manner, genuine synergistic effects that
are too small, for example because the dose-ranges are a bit off, will
also be misclassified. By incorporating the uncertainty into the
classification it can be done in a more principled manner.</p>
<p>In Bayesian inference, we can compute what is know as the model
<em>evidence</em>. That is, given a probabilistic model <span class="math inline">\(\mathcal{M}\)</span>, and some data we think is
generated from it, <span class="math inline">\(\mathcal{D}\)</span>, the
evidence is defined as the probability of the model given the data,
<span class="math inline">\(P(\mathcal{M} \vert \mathcal{D})\)</span>.
We can use this quantity to compare different models, in particular when
comparing two distinct models we can define the <strong>Bayes
Factor,</strong> <span class="math inline">\(\text{BF}_{10}\)</span>:
<span class="math display">\[
\text{BF}_{10}=\frac{P(\mathcal{D}\vert\mathcal{M}_1)}{P(\mathcal{D}\vert\mathcal{M}_0)}
= \frac{P(\mathcal{M}_1 \vert \mathcal{D})}{P(\mathcal{M}_0 \vert
\mathcal{D})}\frac{P(\mathcal{M}_1)}{P(\mathcal{M}_0)},
\]</span> where <span class="math inline">\(P(\mathcal{M}_1)\)</span>
and <span class="math inline">\(P(\mathcal{M}_0)\)</span> denotes the
prior model probabilities. By defining <span class="math display">\[
\mathcal{M}_0: f(\mathbf{x}) = p_0(\mathbf{x}) \\
\mathcal{M}_1: f(\mathbf{x}) = p_0(\mathbf{x}) + \Delta(\mathbf{x}),
\]</span> and computing <span class="math inline">\(\text{BF}_{10}\)</span>, the Bayes factor gives
information on whether the interaction surface needs to be included in
the model. A high value indicates that <span class="math inline">\(\mathcal{M}_1\)</span> is preferred over <span class="math inline">\(\mathcal{M}_0\)</span>, and thus that there most
likely is some interaction in the experiment. One still needs to make a
cutoff, but it will be less arbitrary by connecting it directly to the
uncertainty in the model, and model evidence. The thresholding itself
can be done according to e.g. the table in <span class="citation">Kass
and Raftery (1995)</span>:</p>
<table class="table">
<thead><tr class="header">
<th align="center"><span class="math inline">\(\text{BF}_{10}\)</span></th>
<th align="center">Evidence against <span class="math inline">\(\mathcal{M}_0\)</span>
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">1 to 3.2</td>
<td align="center">Not worth more than a bare mention</td>
</tr>
<tr class="even">
<td align="center">3.2 to 10</td>
<td align="center">Substantial</td>
</tr>
<tr class="odd">
<td align="center">10 to 100</td>
<td align="center">Strong</td>
</tr>
<tr class="even">
<td align="center">&gt;100</td>
<td align="center">Decisive</td>
</tr>
</tbody>
</table>
<p>The Bayes factor only gives information about whether or not an
interaction is present. Depending on the classification task, one still
needs to decide if the effect is synergistic or antagonistic. For this
one could e.g. use the integral of the interaction surface, <span class="math inline">\(\text{VUS}(\Delta)\)</span>, if this is negative
the experiment is coded as synergistic, if positive it is coded as
antagonistic.</p>
<p>The calculation of the Bayes factor is implemented directly in the
<code>bayesynergy</code> function, and can be calculated simply by
adding <code>bayes_factor = T</code> to the call. Model evidence and the
Bayes factor itself is computed via the <code>bridgesampling</code>
package (<span class="citation">Gronau, Singmann, and Wagenmakers
(2020)</span>).</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Fuglstad2018" class="csl-entry">
Fuglstad, Geir-Arne, Daniel Simpson, Finn Lindgren, and Håvard Rue.
2018. <span>“Constructing Priors That Penalize the Complexity of
Gaussian Random Fields.”</span> <em>Journal of the American Statistical
Association</em> 114 (525): 445–52. <a href="https://doi.org/10.1080/01621459.2017.1415907" class="external-link">https://doi.org/10.1080/01621459.2017.1415907</a>.
</div>
<div id="ref-Gagnon2020" class="csl-entry">
Gagnon, Philippe, Alain Desgagné, and Mylène Bédard. 2020. <span>“A New
Bayesian Approach to Robustness Against Outliers in Linear
Regression.”</span> <em>Bayesian Analysis</em> 15 (2). <a href="https://doi.org/10.1214/19-ba1157" class="external-link">https://doi.org/10.1214/19-ba1157</a>.
</div>
<div id="ref-Gronau2020" class="csl-entry">
Gronau, Quentin F., Henrik Singmann, and Eric-Jan Wagenmakers. 2020.
<span>“Bridgesampling: An r Package for Estimating Normalizing
Constants.”</span> <em>Journal of Statistical Software</em> 92 (10). <a href="https://doi.org/10.18637/jss.v092.i10" class="external-link">https://doi.org/10.18637/jss.v092.i10</a>.
</div>
<div id="ref-Kass1995" class="csl-entry">
Kass, Robert E., and Adrian E. Raftery. 1995. <span>“Bayes
Factors.”</span> <em>Journal of the American Statistical
Association</em> 90 (430): 773–95. <a href="https://doi.org/10.1080/01621459.1995.10476572" class="external-link">https://doi.org/10.1080/01621459.1995.10476572</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Leiv Rønneberg, Andrea Cremaschi, Robert Hanes, Chi Zhang, Manuela Zucknick.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
